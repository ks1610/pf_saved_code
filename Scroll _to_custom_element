// Function to wait for an element to exist
function waitForElement(selector, callback, maxWait = 10000) {
  const startTime = Date.now();
  
  const checkElement = setInterval(function() {
    const element = document.querySelector(selector);
    
    if (element) {
      clearInterval(checkElement);
      callback(element);
    } else if (Date.now() - startTime > maxWait) {
      clearInterval(checkElement);
      console.warn('Element not found after waiting:', selector);
    }
  }, 100);
}

// Function to scroll to bundle
function scrollToBundle() {
  console.log('Attempting to scroll to bundle...');
  
  // Wait for bundle element if it doesn't exist yet
  waitForElement('#_bndl_4fy2xdk1ojwh04', function(bundleElement) { // target element id
    console.log('Bundle element found, scrolling...');
    
    // Get element position
    const elementPosition = bundleElement.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - 100; // Adjust this value (100px offset from top)
    
    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
    
    // Optional: Add highlight effect
    bundleElement.style.transition = 'box-shadow 0.3s ease';
    bundleElement.style.boxShadow = '0 0 20px rgba(181, 150, 119, 0.5)';
    
    setTimeout(function() {
      bundleElement.style.boxShadow = '';
    }, 2000);
  });
}

// Alternative: Try searching for any bundler element if the specific ID doesn't work
function scrollToBundleAlternative() {
  console.log('Trying alternative bundle selectors...');
  
  const selectors = [
    '#_bndl_4fy2xdk1ojwh04',
    '.bndlr-volume',
    '[data-bndlr-key="4fy2xdk1ojwh04"]',
    '.bndlr-volume-title'
  ];
  
  for (let selector of selectors) {
    const element = document.querySelector(selector);
    if (element) {
      console.log('Found element with selector:', selector);
      
      const elementPosition = element.getBoundingClientRect().top;
      const offsetPosition = elementPosition + window.pageYOffset - 100;
      
      window.scrollTo({
        top: offsetPosition,
        behavior: 'smooth'
      });
      return;
    }
  }
  
  console.warn('No bundle element found with any selector');
}

// Function to attach event listeners to ALL buttons with class or ID
function attachScrollListeners() {
  // Wait a bit for PageFly to render elements
  setTimeout(function() {
    // Find ALL buttons - using both ID and class selectors
    const buttons = document.querySelectorAll('#pfbutton, .pfbutton, [data-scroll-to-bundle]'); // button class and id name
    
    console.log('Found ' + buttons.length + ' scroll buttons');
    
    buttons.forEach(function(button, index) {
      console.log('Attaching listener to button ' + (index + 1));
      
      // Remove existing listener if any
      button.removeEventListener('click', handleButtonClick);
      
      // Add click listener
      button.addEventListener('click', handleButtonClick);
    });
    
    // If no buttons found, try again with just ID
    if (buttons.length === 0) {
      const singleButton = document.getElementById('pfbutton');
      if (singleButton) {
        console.log('Found single button with ID');
        singleButton.addEventListener('click', handleButtonClick);
      }
    }
  }, 1000);
}

// Separate handler function
function handleButtonClick(e) {
  console.log('Button clicked!');
  e.preventDefault();
  e.stopPropagation();
  
  scrollToBundle();
  
  // If main doesn't work after 500ms, try alternative
  setTimeout(scrollToBundleAlternative, 500);
}

// Initialize on different events
document.addEventListener('DOMContentLoaded', attachScrollListeners);
window.addEventListener('load', attachScrollListeners);

// Try again after delays for PageFly dynamic content
setTimeout(attachScrollListeners, 2000);
setTimeout(attachScrollListeners, 3000);

// Expose functions globally
window.scrollToBundle = scrollToBundle;
window.scrollToBundleAlternative = scrollToBundleAlternative;
window.attachScrollListeners = attachScrollListeners;
